"use strict";var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}define(["jquery","core/config","core/str","core/yui","core/event"],function($,mConfig,mString,Y,mEvent){var session={courseModuleId:0,activityId:0,sessionId:0,attemptId:0,sessionKey:""},cache=[],Ajax=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"request",value:function(e,t,n,i){return n.id=session.courseModuleId,n.sessionid=session.sessionId,n.attemptid=session.attemptId,n.sesskey=session.sessionKey,$.ajax({type:e,url:t,data:n,dataType:"json",success:i,error:function(e,t,n){}}).fail(function(){return setText(Quiz.info,"error_with_request")})}},{key:"get",value:function(t,n,i){return n.action=t,e.request("get","ajax.php",n,i)}},{key:"post",value:function(t,n,i){return n.action=t,e.request("post","ajax.php",n,i)}}]),e}(),Question=function(){function Question(e){_classCallCheck(this,Question),this.quiz=e,this.isRunning=!1,this.isSaving=!1,this.endTime=0,this.isVoteRunning=!1,this.hasVotes=!1,this.countdownTimeLeft=0,this.questionTime=0,this.countdownInterval=0,this.timerInterval=0}return _createClass(Question,[{key:"refresh",value:function refresh(){var _this=this;Ajax.get("get_question_form",{},function(data){data.is_already_submitted?setText(Quiz.info,"wait_for_instructor"):(Quiz.show(Question.box.html(data.html)),eval(data.js),data.css.forEach(function(e){var t=document.getElementsByTagName("head")[0],n=document.createElement("link");n.rel="stylesheet",n.type="text/css",n.href=e,t.appendChild(n)}),_this.quiz.role.onQuestionRefreshed(data),Quiz.renderAllMathjax())})}},{key:"hideTimer",value:function(){Quiz.hide(Question.timer),clearInterval(this.timerInterval),this.timerInterval=0}},{key:"onCountdownTick",value:function(e){this.countdownTimeLeft--,this.countdownTimeLeft<=0?(clearInterval(this.countdownInterval),this.countdownInterval=0,this.startAttempt(e)):0!==this.countdownTimeLeft?setText(Quiz.info,"question_will_start_in_x_seconds","swiftquiz",this.countdownTimeLeft):setText(Quiz.info,"question_will_start_now")}},{key:"startCountdown",value:function(e,t){var n=this;return 0!==this.countdownInterval||(e=parseInt(e),t=parseInt(t),this.countdownTimeLeft=t,t<1?!(e>0&&t<-e)&&(e>1?this.startAttempt(e+t):this.startAttempt(0),!0):(this.countdownInterval=setInterval(function(){return n.onCountdownTick(e)},1e3),!0))}},{key:"onTimerEnding",value:function(){this.isRunning=!1,this.quiz.role.onTimerEnding()}},{key:"onTimerTick",value:function(){var e=(new Date).getTime();if(e>this.endTime)this.hideTimer(),this.onTimerEnding();else{var t=parseInt((this.endTime-e)/1e3);this.quiz.role.onTimerTick(t)}}},{key:"startAttempt",value:function(e){var t=this;Quiz.hide(Quiz.info),this.refresh(),this.isRunning=!0,0!==(e=parseInt(e))&&(this.quiz.role.onTimerTick(e),this.endTime=(new Date).getTime()+1e3*e,this.timerInterval=setInterval(function(){return t.onTimerTick()},1e3))}}],[{key:"isLoaded",value:function(){return""!==Question.box.html()}},{key:"box",get:function(){return $("#swiftquiz_question_box")}},{key:"timer",get:function(){return $("#swiftquiz_question_timer")}},{key:"form",get:function(){return $("#swiftquiz_question_form")}}]),Question}(),Quiz=function(){function e(t){_classCallCheck(this,e),this.state="",this.isNewState=!1,this.question=new Question(this),this.role=new t(this),this.events={notrunning:"onNotRunning",preparing:"onPreparing",running:"onRunning",reviewing:"onReviewing",sessionclosed:"onSessionClosed",voting:"onVoting"}}return _createClass(e,[{key:"changeQuizState",value:function(e,t){this.isNewState=this.state!==e,this.state=e,this.role.onStateChange(e);var n=this.events[e];this.role[n](t)}},{key:"poll",value:function(e){var t=this;Ajax.get("info",{},function(n){t.changeQuizState(n.status,n),setTimeout(function(){return t.poll(e)},e)})}}],[{key:"hide",value:function(e){e.addClass("hidden")}},{key:"show",value:function(e){e.removeClass("hidden")}},{key:"uncheck",value:function(e){e.children(".fa").removeClass("fa-check-square-o").addClass("fa-square-o")}},{key:"check",value:function(e){e.children(".fa").removeClass("fa-square-o").addClass("fa-check-square-o")}},{key:"renderAllMathjax",value:function(){mEvent.notifyFilterContentUpdated(document.getElementsByClassName("swiftquiz-response-container"))}},{key:"addMathjaxElement",value:function(t,n){t.html('<span class="filter_mathjaxloader_equation">'+n+"</span>"),e.renderAllMathjax()}},{key:"renderMaximaEquation",value:function(t,n){null!==document.getElementById(n)&&(void 0===cache[t]?Ajax.get("stack",{input:encodeURIComponent(t)},function(t){cache[t.original]=t.latex,e.addMathjaxElement($("#"+n),t.latex)}):e.addMathjaxElement($("#"+n),cache[t]))}},{key:"main",get:function(){return $("#swiftquiz")}},{key:"info",get:function(){return $("#swiftquiz_info_container")}},{key:"responded",get:function(){return $("#swiftquiz_responded_container")}},{key:"responses",get:function(){return $("#swiftquiz_responses_container")}},{key:"responseInfo",get:function(){return $("#swiftquiz_response_info_container")}}]),e}();function setText(e,t,n,i){n=void 0!==n?n:"swiftquiz",i=void 0!==i?i:[],$.when(mString.get_string(t,n,i)).done(function(t){return Quiz.show(e.html(t))})}return{initialize:function(e,t,n,i,s){session.courseModuleId=e,session.activityId=t,session.sessionId=n,session.attemptId=i,session.sessionKey=s},Quiz:Quiz,Question:Question,Ajax:Ajax,setText:setText}});